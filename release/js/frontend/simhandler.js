var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,t){r.__proto__=t}||function(r,t){for(var e in t)t.hasOwnProperty(e)&&(r[e]=t[e])};return function(t,e){function s(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(s.prototype=e.prototype,new s)}}();define(["require","exports","./events","../shared/model"],function(r,t,e,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){return function(r,t){this.progress=r,this.activeWorkers=t}}();t.ProgressInfo=o;var n=function(r){function t(t,e){var s=r.call(this)||this;return s.progress=0,s.simResult=null,s.numWorkers=t,s.thisWorkerNumber=e,s.worker=new Worker("js/worker/loader.js"),$(s.worker).on("message",s.onMessage.bind(s)),s}return __extends(t,r),t.prototype.run=function(r){this.progress=0,this.simResult=null,this.worker.postMessage({model:r,numThreads:this.numWorkers,thisThreadNumber:this.thisWorkerNumber})},t.prototype.getProgress=function(){return this.progress},t.prototype.getResult=function(){return this.simResult},t.prototype.isRunning=function(){return null===this.simResult},t.prototype.onMessage=function(r){var t=r.originalEvent.data;"start"===t.event?(this.simResult=null,this.trigger("start")):"progress"===t.event?(this.progress=t.progress,this.trigger("progress",this.progress)):"done"===t.event&&(this.simResult=JSON.parse(t.result,s.inflater),this.progress=100,this.trigger("done",this.simResult))},t}(e.Events),i=function(r){function t(){var t=r.call(this)||this;t.workers=[],t.started=!1,"hardwareConcurrency"in window.navigator?(t.numWorkers=window.navigator.hardwareConcurrency,t.numWorkers<1&&(t.numWorkers=1)):(console.log("Browser does not support determination of hardware concurrency. Using 1 worker only."),t.numWorkers=1);for(var e=0;e<t.numWorkers;e++)t.workers[e]=new n(t.numWorkers,e),t.workers[e].on("start",t.onStart.bind(t)),t.workers[e].on("progress",t.onProgress.bind(t)),t.workers[e].on("done",t.onDone.bind(t));return t}return __extends(t,r),t.prototype.getNumWorkers=function(){return this.numWorkers},t.prototype.onStart=function(){this.started||(this.trigger("start"),this.started=!0)},t.prototype.onProgress=function(){for(var r=0,t=0,e=0,s=this.workers;e<s.length;e++){var n=s[e];r+=n.getProgress(),n.isRunning()&&t++}r/=this.numWorkers,this.trigger("progress",new o(r,t))},t.prototype.onDone=function(){for(var r=!0,t=0,e=this.workers;t<e.length;t++)if((i=e[t]).isRunning()){r=!1;break}if(r){for(var s=null,o=0,n=this.workers;o<n.length;o++){var i=n[o];s=null==s?i.getResult():s.combine(i.getResult())}this.trigger("done",s),this.started=!1}},t.prototype.run=function(r){this.started=!1;for(var t=JSON.stringify(r),e=0;e<this.numWorkers;e++)this.workers[e].run(t)},t}(e.Events);t.SimHandler=i});