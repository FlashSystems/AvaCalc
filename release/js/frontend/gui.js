define(["require","exports","./cy","./simhandler"],function(t,e,i,o){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(){$(".modal").modal({ready:function(t){var e=t.find("ul.tabs li a.active").first();e.length>0&&e.parent().parent().tabs("select_tab",e.attr("href").substring(1)),t.find("input.autofocus").first().focus()}}),$(".dropdown-button").dropdown({constrainWidth:!1,gutter:0,belowOrigin:!0,alignment:"right"}),$("ul.tabs").tabs(),$(".tooltipped").tooltip({position:"bottom",delay:500}),$("select").material_select(),this.ca=new i.CytoscapeApi,this.ca.on("add",this.addService.bind(this)),this.ca.on("link",this.linkNode.bind(this)),this.ca.on("delete",this.deleteNode.bind(this)),this.ca.on("edit",this.editNode.bind(this)),this.ca.on("clone",this.cloneNode.bind(this)),this.ca.addSTP(),this.sim=new o.SimHandler,this.sim.on("start",this.simStart.bind(this)),this.sim.on("done",this.simDone.bind(this)),this.sim.on("progress",this.simProgress.bind(this));var t=this.sim.getNumWorkers();$("#cores").text(t+" "+(t>1?"parallel threads":"thread")),$("#menuSave").on("click",this.saveClick.bind(this)),$("#menuLoad").on("click",this.loadClick.bind(this)),$("#menuSimulateStart").on("click",this.simulateStartClick.bind(this)),$("#menuSimulateStop").on("click",this.simulateStopClick.bind(this)),$("#menuResetZoom").on("click",this.resetZoomClick.bind(this)),$("#btnClear").on("click",this.clearClick.bind(this)),$("#addDevice").on("click",this.onAddDevice.bind(this)),$("#addService").on("click",this.onAddService.bind(this)),$("#alignHorizontal").on("click",this.onAlignH.bind(this)),$("#alignVertical").on("click",this.onAlignV.bind(this)),$("#distributeHorizontal").on("click",this.onDistributeH.bind(this)),$("#distributeVertical").on("click",this.onDistributeV.bind(this)),$("#flavour").on("change",this.onFlavourChange.bind(this)),$(document).on("keypress",null,"d",this.onHotkey.bind(this,"d")),$(document).on("keypress",null,"s",this.onHotkey.bind(this,"s")),$(document).on("keypress",null,"l",this.onHotkey.bind(this,"l")),$(document).on("keypress",null,"c",this.onHotkey.bind(this,"c"))}return t.prototype.editDialog=function(t,e,i,o){for(var n in e){var a=t.find("input[data-link="+n+"]");if(a.length>0){if(a.val(e[n]),a.hasClass("autocomplete"))if(n in i){for(var s={},r=0,l=i[n];r<l.length;r++)s[l[r]]=null;a.autocomplete({data:s,limit:10,minLength:2})}else console.log("Autocomplete values missing for #"+n)}else{var c=t.find("select[data-link="+n+"]");c.length>0&&(c.val(e[n]),c.trigger("change"),c.material_select())}}t.find("input.allowenter").off("keypress").on("keypress",function(e){13==e.originalEvent.keyCode&&(e.stopPropagation(),t.find("a.btn-ok").click())}),t.find("a.btn-ok").off("click").on("click",function(){for(var i in e){var n=t.find("input[data-link="+i+"]");0===n.length&&(n=t.find("select[data-link="+i+"]")),n.length>0&&(e[i]=n.val())}var a;try{a=o(e)}catch(t){a=t}!0===a?t.modal("close"):Materialize.toast('<span class="mdi mdi-textbox">'+a+"</span>",3e3,"error")}),t.modal("open")},t.prototype.addService=function(t){var e=this;$.isArray(t)||(t=[t]);var o=new i.CyService,n={name:this.ca.getNameCompletions(o)};this.editDialog($("#dlgEditService"),o.getData(),n,function(i){for(var n=0,a=t;n<a.length;n++){var s=a[n];e.ca.addService(s,o)}return!0})},t.prototype.saveClick=function(){$.savefile.file("text/json","design.avac",this.ca.save())},t.prototype.loadClick=function(){var t=this;$("#loadFile").off("change").on("change",function(e){var i=new FileReader;i.onload=function(e){t.ca.load(e.target.result)},i.readAsText(e.target.files[0],"UTF-8")}).click()},t.prototype.simulateStartClick=function(){$("#menuSimulateStart").parent().hide(),$("#menuSimulateStop").parent().show(),this.sim.run(this.ca.getModel())},t.prototype.simulateStopClick=function(){},t.prototype.linkNode=function(t){this.ca.startLinking(t)},t.prototype.deleteNode=function(t){this.ca.deleteNode(t)},t.prototype.editNode=function(t){var e,o={name:this.ca.getNameCompletions(t)};t instanceof i.CyService?e=$("#dlgEditService"):t instanceof i.CyDevice&&(e=$("#dlgEditDevice")),this.editDialog(e,t.getData(),o,function(e){return t.commit(),!0})},t.prototype.cloneNode=function(t){var e=this;if(t instanceof i.CyDevice){var o={name:this.ca.getNameCompletions(t)},n=$("#dlgCloneDevice");this.editDialog(n,t.getData(),o,function(i){var o=t.enumServices();e.ca.addDevice(t);for(var n=0,a=o;n<a.length;n++){var s=a[n];e.ca.addService(t,s)}return!0})}},t.prototype.simStart=function(){$("#progressBar").css("width","0%"),$("#simProgress").animate({height:"64px"});var t=this.sim.getNumWorkers();$("#runningWorkers").text(t+" "+(t>1?"parallel threads":"thread")),this.simStartTime=(new Date).getTime()},t.prototype.formatDuration=function(t){var e=0,i=0;t-=60*(e=Math.floor(t/6e4))*1e3,t-=1e3*(i=Math.floor(t/1e3));var o="";return e>0&&(o+=e.toString()+"m "),(i>0||e>0)&&(o+=i.toString()+"s "),o+=t.toString()+"ms"},t.prototype.showDowntime=function(t,e,i,o){var n=60*e*(1-o)*i,a=0,s=0,r=0;n-=24*(a=Math.floor(n/1440))*60,n-=60*(s=Math.floor(n/60)),r=Math.floor(n);var l="";a>0&&(l+=a.toString()+"d "),(a>0||s>0)&&(l+=s.toString()+"h "),l+=r.toString()+"m",t.text(l)},t.prototype.simDone=function(t){var e=this,i=(new Date).getTime()-this.simStartTime;if($("#simProgress").animate({height:"0"}),t.error)$("#simErrorText").text(t.error),$("#simError").modal("open");else{if($("#simAva").text((100*t.availability).toFixed(5)),$("#simDuration").text(this.formatDuration(i)),[52,4,1].forEach(function(i){e.showDowntime($("#ava7x24w"+i.toString()),168,i,t.availability),e.showDowntime($("#ava5x10w"+i.toString()),50,i,t.availability),e.showDowntime($("#ava6x8w"+i.toString()),48,i,t.availability),e.showDowntime($("#ava5x8w"+i.toString()),40,i,t.availability)}),$("#spofs").empty(),0===t.singlePointsOfFailure.length)$("#spofs").append($("<li></li>",{class:"nospof",text:"No single points of failure found."})),$("#simSpofLine").hide();else{for(var o=0,n=t.singlePointsOfFailure;o<n.length;o++){var a=n[o],s=this.ca.getNodeById(a);$("#spofs").append($("<li></li>",{class:"spof",text:s.getName()}))}$("#simSpofLine").show(),$("#simSpofCount").text(t.singlePointsOfFailure.length)}$("#simResultTabs").tabs("select_tab","simResultAva"),$("#simResult").modal("open")}$("#menuSimulateStop").parent().hide(),$("#menuSimulateStart").parent().show()},t.prototype.simProgress=function(t){$("#progressBar").css("width",t.progress.toString()+"%"),$("#runningWorkers").text(t.activeWorkers+" "+(t.activeWorkers>1?"parallel threads":"thread"))},t.prototype.onAddDevice=function(){var t=this,e=new i.CyDevice,o={name:this.ca.getNameCompletions(e)};this.editDialog($("#dlgEditDevice"),e.getData(),o,function(i){return console.log(i),t.ca.addDevice(e),!0})},t.prototype.onAddService=function(){var t=this.ca.getSelected().filter(function(t){return t instanceof i.CyDevice});t.length>0?this.addService(t):Materialize.toast('<span class="mdi mdi-alert">Please select a parent device first.</span>',3e3,"error")},t.prototype.resetZoomClick=function(){this.ca.resetZoom()},t.prototype.clearClick=function(){this.ca.clear(),this.ca.addSTP()},t.prototype.onAlignV=function(){this.ca.alignSelected(i.AlignMode.Vertical)},t.prototype.onAlignH=function(){this.ca.alignSelected(i.AlignMode.Horizontal)},t.prototype.onDistributeV=function(){this.ca.distributeSelected(i.AlignMode.Vertical)},t.prototype.onDistributeH=function(){this.ca.distributeSelected(i.AlignMode.Horizontal)},t.prototype.onFlavourChange=function(){"module"===$("#flavour").val()?$("#flavourModuleInfo").show():$("#flavourModuleInfo").hide()},t.prototype.onHotkey=function(t){var e=this.ca.getSelected();if(0===$(".modal:visible").length)switch(t){case"d":this.onAddDevice();break;case"s":this.onAddService();break;case"c":1===e.length&&e[0]instanceof i.CyNode&&this.cloneNode(e[0]);break;case"l":1===e.length&&this.linkNode(e[0])}},t}();e.Main=n});