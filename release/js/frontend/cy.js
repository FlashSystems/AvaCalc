var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}();define(["require","exports","../shared/model","./events","./popup","./tools"],function(e,t,o,n,i,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(s=t.AlignMode||(t.AlignMode={}));var a;!function(e){e[e.X=0]="X",e[e.Y=1]="Y"}(a||(a={}));var c=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),e instanceof Object&&e.hasOwnProperty("x")&&e.hasOwnProperty("y")?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t)}return e.prototype.toPlainObject=function(){return{x:this.x,y:this.y}},e}(),d=function(){return function(e){void 0===e&&(e=""),this.name=e}}(),l=function(){function e(){}return e.wrap=function(e){switch(e.data("type")){case"device":return new h(e);case"service":return new y(e);case"stp":return new p(e);default:throw"Invalid node type"}},e}(),u=function(){function e(e){this.node=e,this.data=null!=e?new d(e.data("label")):new d}return e.prototype.isBound=function(){return null!=this.node},e.prototype.id=function(){if(null==this.node)throw"Can not get id of unbound node";return this.node.id()},e.prototype.boundingBox=function(){if(null==this.node)throw"Can not get bounding box of unbound node";return this.node.boundingBox()},e.prototype.getName=function(){return this.data.name},e.prototype.getData=function(){return this.data},e.prototype.commit=function(e){if(null!=e&&(this.node=e),null==this.node)throw"Commit can only be called without an argument for already bound nodes.";if(0===this.data.name.length)throw"Please specify a device name.";this.node.data("label",this.data.name)},e.prototype.getPercentage=function(e,t){if(!isFinite(e)||isNaN(e))throw t;var o=parseFloat(e);if(isNaN(o)||o<0||o>100)throw t;return o},e}();t.CyNode=u;var p=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t}(u),h=function(e){function t(t){var o=e.call(this,t)||this;return null!=t?(o.data.availability=100*o.node.data("ava"),o.data.flavour=o.node.data("flavour")):(o.data.availability=99.5,o.data.flavour="server"),o}return __extends(t,e),t.prototype.enumServices=function(){return this.node.children("node[type = 'service']").map(function(e){return l.wrap(e)})},t.prototype.commit=function(t){var o=this.getPercentage(this.data.availability,"Availability must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("ava",o/100),this.node.data("flavour",this.data.flavour)},t}(u);t.CyDevice=h;var y=function(e){function t(t){var o=e.call(this,t)||this;return o.data.capacity=null!=t?o.node.data("capacity"):100,o}return __extends(t,e),t.prototype.commit=function(t){var o=this.getPercentage(this.data.capacity,"Capacity must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("capacity",o)},t}(u);t.CyService=y;var g=function(e){function t(){var t=e.call(this)||this;return t.selectStack=[],t.buttonsForType={},t.linkSource=null,t.cy=cytoscape({container:$("#cycanvas"),minZoom:.2,maxZoom:5,style:[{selector:"node",style:{label:"data(label)","text-halign":"center","text-valign":"bottom","text-margin-y":"4px","background-repeat":"no-repeat","background-color":"#f0f0f0","background-fit":"none","background-image-opacity":.4,"border-width":"1px","border-style":"solid","border-color":"#a0a0a0"}},{selector:"edge",style:{}},{selector:"node:selected",style:{"border-width":"4px","border-style":"double","border-color":"#800000"}},{selector:"edge:selected",style:{}},{selector:"node.device",style:{shape:"rectangle",width:"12em","min-width":"12em",height:"4em","min-height":"4em","background-color":"#a0c0ff","background-width":"80%","background-height":"80%","compound-sizing-wrt-labels":"include"}},{selector:"node.device[flavour='server']",style:{"background-image":["images/device-server.svg"]}},{selector:"node.device[flavour='network']",style:{"background-image":["images/device-network.svg"]}},{selector:"node.device[flavour='gateway']",style:{"background-image":["images/device-gateway.svg"]}},{selector:"node.device[flavour='power']",style:{"background-image":["images/device-power.svg"]}},{selector:"node.device[flavour='connection']",style:{"background-image":["images/device-connection.svg"]}},{selector:"node.device[flavour='module']",style:{"background-image":["images/device-module.svg"]}},{selector:"node.device[flavour='storage']",style:{"background-image":["images/device-storage.svg"]}},{selector:"node.device[flavour='fabric']",style:{"background-image":["images/device-fabric.svg"]}},{selector:"$node.device > node",style:{"background-position-x":-33,"background-position-y":0,"background-width":"32px","background-height":"32px","background-clip":"none"}},{selector:"edge.device",style:{"curve-style":"haystack","line-style":"dashed","line-color":"#a0c0ff"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}},{selector:"node.stp",style:{shape:"roundrectangle","background-color":"#ffa0af","background-width":"2em","background-height":"2em","background-image":["images/stp.svg"],width:"4em",height:"2em"}},{selector:"edge.service",style:{"curve-style":"bezier","line-style":"solid","line-color":"#004000","arrow-scale":2,"target-arrow-shape":"triangle","target-arrow-color":"#004000"}},{selector:"edge.selneighborhood",style:{"line-color":"#800000","target-arrow-color":"#800000"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}}]}),t.cy.snapToGrid({gridSpacing:30,lineDash:[2,2],zoomDash:!0,selector:"node[type = 'device']"}),t.buttonsForType={device:i.Buttons.Add|i.Buttons.Edit|i.Buttons.Link|i.Buttons.Delete|i.Buttons.Clone,service:i.Buttons.Edit|i.Buttons.Link|i.Buttons.Delete,stp:i.Buttons.Link,edge:i.Buttons.Delete},t.cy.on("select","node",function(e){t.onSelectNode(e)}),t.cy.on("select","edge",function(e){t.onSelectEdge(e)}),t.cy.on("unselect","*",function(e){t.onUnSelect(e)}),t.cy.on("drag","node",function(e){t.onDrag(e)}),t.cy.on("free","node",function(e){t.onFree(e)}),t.cy.on("pan",function(e){t.onPan(e)}),t.cy.on("zoom",function(e){t.onZoom(e)}),t.cy.on("mouseover",function(e){t.onMouseOver(e)}),t.cy.on("mouseout",function(e){t.onMouseOut(e)}),t.cy.on("click",function(e){t.onClick(e)}),t.linkSource=null,t}return __extends(t,e),t.prototype.getNodeLabels=function(e){for(var t=[],o=0,n=this.cy.nodes(e);o<n.length;o++){var i=n[o].data("label");-1==t.indexOf(i)&&t.push(i)}return t},t.prototype.getSelectedCyNode=function(){return this.cy.$(":selected")},t.prototype.showPopup=function(e){if(!this.linkSource&&!e.scratch("popup")){var t=r.translateViewport($("#cycanvas"),e.renderedBoundingBox()),o=void 0;if(e.isNode()){var n=this.buttonsForType[e.data("type")];if(!n)return;o=new i.Popup(n,l.wrap(e)),e.scratch("popup",o),o.show(t.x1+(t.x2-t.x1-o.width())/2,t.y1-o.height())}else o=new i.Popup(i.Buttons.Delete,l.wrap(e)),e.scratch("popup",o),o.show(t.x1+(t.x2-t.x1-o.width())/2,t.y1+(t.y2-t.y1-o.height())/2);o.pass("add",this),o.pass("link",this),o.pass("edit",this),o.pass("delete",this),o.pass("clone",this)}},t.prototype.clearPopup=function(e){var t=e.scratch("popup");t&&t.destroy(),e.removeScratch("popup")},t.prototype.isLinkable=function(e,t){if(e&&t&&e.isNode()&&t.isNode()){var o=e.data("type"),n=t.data("type");return!e.edgesTo(t).length&&!t.edgesTo(e).length&&((o===n||"stp"===o||"device"===o&&"stp"===n)&&e.id()!==t.id())}return!1},t.prototype.addSTP=function(){this.cy.add({group:"nodes",classes:"stp",position:{x:this.cy.width()/2,y:30},data:{label:"Service Transfer Point",type:"stp"}})},t.prototype.addDevice=function(e){if(e.isBound()){var t=this.cy.getElementById(e.id());t.unselect(),this.clearPopup(t)}var o=this.cy.add({group:"nodes",classes:"device",position:{x:this.cy.width()/2,y:this.cy.height()/2},data:{type:"device"}});try{e.commit(o)}catch(e){throw this.cy.remove(o),e}},t.prototype.addService=function(e,t){if(t.isBound()){var o=this.cy.getElementById(t.id());o.unselect(),this.clearPopup(o)}var n=e.boundingBox(),i=this.cy.add({group:"nodes",classes:"service",position:{x:n.x1+n.w/2,y:n.y1+n.h/2},data:{parent:e.id(),type:"service"}});try{t.commit(i)}catch(e){throw this.cy.remove(i),e}},t.prototype.getNodeById=function(e){return l.wrap(this.cy.getElementById(e))},t.prototype.getNameCompletions=function(e){if(e instanceof h)return this.getNodeLabels("node[type = 'device']");if(e instanceof y)return this.getNodeLabels("node[type = 'service']");throw"Invalid parameter"},t.prototype.deleteNode=function(e){this.getSelectedCyNode().unselect(),this.cy.remove(this.cy.getElementById(e.id()))},t.prototype.getSelected=function(){return this.getSelectedCyNode().map(function(e){return l.wrap(e)})},t.prototype.startLinking=function(e){this.linkSource=this.cy.getElementById(e.id()),$("#cycanvas").css("cursor","no-drop"),this.getSelectedCyNode().unselect()},t.prototype.save=function(){return JSON.stringify(this.cy.json().elements)},t.prototype.load=function(e){this.getSelectedCyNode().unselect(),this.linkSource=void 0,this.clear(),this.cy.json({elements:JSON.parse(e)})},t.prototype.clear=function(){this.getSelectedCyNode().unselect(),this.cy.elements().remove()},t.prototype.resetZoom=function(){this.cy.reset()},t.prototype.getModel=function(){for(var e=new o.Stp(this.cy.nodes('[type = "stp"]').first().id()),t=new o.Model(e),n=0,i=this.cy.nodes('node[type = "device"]');n<i.length;n++)!function(e){var n=new o.Device(e.id(),e.data("ava"),"module"===e.data("flavour"));e.children('node[type = "service"]').map(function(e){n.addService(new o.Service(e.id(),e.data("label"),e.data("capacity")))});t.addDevice(n)}(i[n]);for(var r=0,s=this.cy.edges();r<s.length;r++){var a=s[r],c=a.data("type"),d=c.charAt(0).toUpperCase()+c.substr(1).toLowerCase(),l=o.LinkType[d];t.addLink(new o.Link(l,a.source().id(),a.target().id()))}return t},t.prototype.moveNodeTo=function(e,t,o){var n=e.position(),i=new c;if(o==a.Y?i.y=t.y-n.y:i.x=t.x-n.x,e.isParent())for(var r=0,s=e.children();r<s.length;r++)s[r].shift(i.toPlainObject());else e.shift(i.toPlainObject())},t.prototype.alignSelected=function(e){if(!(this.selectStack.length<2))for(var t=this.selectStack[0].position(),o=e===s.Horizontal?a.Y:a.X,n=0,i=this.cy.$("node:selected");n<i.length;n++){var r=i[n];this.moveNodeTo(r,t,o)}},t.prototype.distributeSelected=function(e){if(!(this.selectStack.length<3)){for(var t=[],o=0,n=this.cy.$("node:selected");o<n.length;o++){h=n[o];t.push(h)}t.sort(function(t,o){var n=e===s.Horizontal?t.position().x:t.position().y,i=e===s.Horizontal?o.position().x:o.position().y,r=e===s.Horizontal?t.position().y:t.position().x,a=e===s.Horizontal?o.position().y:o.position().x,c=n-i;return 0!=c?c:r-a});for(var i=t.length-1,r=e===s.Horizontal?t[0].position().x:t[0].position().y,d=((e===s.Horizontal?t[i].position().x:t[i].position().y)-r)/i,l=e===s.Horizontal?a.X:a.Y,u=0,p=t;u<p.length;u++){var h=p[u];this.moveNodeTo(h,new c(r,r),l),r+=d}}},t.prototype.onSelectNode=function(e){if(null!=this.linkSource){var t=e.target;if(this.isLinkable(this.linkSource,t)){var o=t.data("type");"stp"==o&&(o="device"),this.cy.add({group:"edges",classes:o,data:{type:o,source:this.linkSource.id(),target:t.id()}})}else this.trigger("error","Invalid target selected.");$("#cycanvas").css("cursor",""),this.linkSource=null}else{if(this.selectStack.push(e.target),1!=this.getSelectedCyNode().length)for(var n=0,i=this.getSelectedCyNode();n<i.length;n++){var r=i[n];this.clearPopup(r)}else this.showPopup(e.target);e.target.neighborhood().addClass("selneighborhood")}},t.prototype.onSelectEdge=function(e){this.showPopup(e.target)},t.prototype.onUnSelect=function(e){var t=e.target;this.clearPopup(t),this.selectStack=this.selectStack.filter(function(e){return e.id()!=t.id()}),t.neighborhood().removeClass("selneighborhood")},t.prototype.onDrag=function(e){this.clearPopup(e.target)},t.prototype.onFree=function(e){1==this.getSelectedCyNode().length&&this.showPopup(this.getSelectedCyNode().first())},t.prototype.onPan=function(e){this.getSelectedCyNode().unselect()},t.prototype.onZoom=function(e){this.getSelectedCyNode().unselect()},t.prototype.onMouseOver=function(e){null!=this.linkSource&&e.target&&e.target!==this.cy&&(this.isLinkable(this.linkSource,e.target)?$("#cycanvas").css("cursor","alias"):$("#cycanvas").css("cursor","no-drop"))},t.prototype.onMouseOut=function(e){this.linkSource&&$("#cycanvas").css("cursor","no-drop")},t.prototype.onClick=function(e){null!=this.linkSource&&e.target&&e.target===this.cy&&(this.linkSource=null,$("#cycanvas").css("cursor",""))},t}(n.Events);t.CytoscapeApi=g});