"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),CytoscapeApi;!function(e){var t;!function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"}(t=e.AlignMode||(e.AlignMode={}));var o;!function(e){e[e.X=0]="X",e[e.Y=1]="Y"}(o||(o={}));var n=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),e instanceof Object&&e.hasOwnProperty("x")&&e.hasOwnProperty("y")?(this.x=e.x,this.y=e.y):(this.x=e,this.y=t)}return e.prototype.toPlainObject=function(){return{x:this.x,y:this.y}},e}(),i=function(){return function(e){void 0===e&&(e=""),this.name=e}}(),r=function(){function e(){}return e.wrap=function(e){switch(e.data("type")){case"device":return new c(e);case"service":return new d(e);case"stp":return new a(e);default:throw"Invalid node type"}},e}(),s=function(){function e(e){this.node=e,this.data=null!=e?new i(e.data("label")):new i}return e.prototype.isBound=function(){return null!=this.node},e.prototype.id=function(){if(null==this.node)throw"Can not get id of unbound node";return this.node.id()},e.prototype.boundingBox=function(){if(null==this.node)throw"Can not get bounding box of unbound node";return this.node.boundingBox()},e.prototype.getName=function(){return this.data.name},e.prototype.getData=function(){return this.data},e.prototype.commit=function(e){if(null!=e&&(this.node=e),null==this.node)throw"Commit can only be called without an argument for already bound nodes.";if(0===this.data.name.length)throw"Please specify a device name.";this.node.data("label",this.data.name)},e.prototype.getPercentage=function(e,t){if(!isFinite(e)||isNaN(e))throw t;var o=parseFloat(e);if(isNaN(o)||o<0||o>100)throw t;return o},e}();e.CyNode=s;var a=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t}(s),c=function(e){function t(t){var o=e.call(this,t)||this;return null!=t?(o.data.availability=100*o.node.data("ava"),o.data.flavour=o.node.data("flavour")):(o.data.availability=99.5,o.data.flavour="server"),o}return __extends(t,e),t.prototype.enumServices=function(){return this.node.children("node[type = 'service']").map(function(e){return r.wrap(e)})},t.prototype.commit=function(t){var o=this.getPercentage(this.data.availability,"Availability must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("ava",o/100),this.node.data("flavour",this.data.flavour)},t}(s);e.CyDevice=c;var d=function(e){function t(t){var o=e.call(this,t)||this;return o.data.capacity=null!=t?o.node.data("capacity"):100,o}return __extends(t,e),t.prototype.commit=function(t){var o=this.getPercentage(this.data.capacity,"Capacity must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("capacity",o)},t}(s);e.CyService=d;var l=function(e){function i(){var t=e.call(this)||this;return t.selectStack=[],t.buttonsForType={},t.linkSource=null,t.cy=cytoscape({container:$("#cycanvas"),minZoom:.2,maxZoom:5,style:[{selector:"node",style:{label:"data(label)","text-halign":"center","text-valign":"bottom","text-margin-y":"4px","background-repeat":"no-repeat","background-color":"#f0f0f0","background-fit":"none","background-image-opacity":.4,"border-width":"1px","border-style":"solid","border-color":"#a0a0a0"}},{selector:"edge",style:{}},{selector:"node:selected",style:{"border-width":"4px","border-style":"double","border-color":"#800000"}},{selector:"edge:selected",style:{}},{selector:"node.device",style:{shape:"rectangle",width:"12em","min-width":"12em",height:"4em","min-height":"4em","background-color":"#a0c0ff","background-width":"80%","background-height":"80%","compound-sizing-wrt-labels":"include"}},{selector:"node.device[flavour='server']",style:{"background-image":["images/device-server.svg"]}},{selector:"node.device[flavour='network']",style:{"background-image":["images/device-network.svg"]}},{selector:"node.device[flavour='gateway']",style:{"background-image":["images/device-gateway.svg"]}},{selector:"node.device[flavour='power']",style:{"background-image":["images/device-power.svg"]}},{selector:"node.device[flavour='connection']",style:{"background-image":["images/device-connection.svg"]}},{selector:"node.device[flavour='module']",style:{"background-image":["images/device-module.svg"]}},{selector:"$node.device > node",style:{"background-image":[]}},{selector:"edge.device",style:{"curve-style":"haystack","line-style":"dashed","line-color":"#a0c0ff"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}},{selector:"node.stp",style:{shape:"roundrectangle","background-color":"#ffa0af","background-width":"2em","background-height":"2em","background-image":["images/stp.svg"],width:"4em",height:"2em"}},{selector:"edge.service",style:{"curve-style":"bezier","line-style":"solid","line-color":"#004000","arrow-scale":2,"target-arrow-shape":"triangle","target-arrow-color":"#004000"}},{selector:"edge.selneighborhood",style:{"line-color":"#800000","target-arrow-color":"#800000"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}}]}),t.cy.snapToGrid({gridSpacing:30,lineDash:[2,2],zoomDash:!0,selector:"node[type = 'device']"}),t.buttonsForType={device:Popup.Buttons.Add|Popup.Buttons.Edit|Popup.Buttons.Link|Popup.Buttons.Delete|Popup.Buttons.Clone,service:Popup.Buttons.Edit|Popup.Buttons.Link|Popup.Buttons.Delete,stp:Popup.Buttons.Link,edge:Popup.Buttons.Delete},t.cy.on("select","node",function(e){t.onSelectNode(e)}),t.cy.on("select","edge",function(e){t.onSelectEdge(e)}),t.cy.on("unselect","*",function(e){t.onUnSelect(e)}),t.cy.on("drag","node",function(e){t.onDrag(e)}),t.cy.on("free","node",function(e){t.onFree(e)}),t.cy.on("pan",function(e){t.onPan(e)}),t.cy.on("zoom",function(e){t.onZoom(e)}),t.cy.on("mouseover",function(e){t.onMouseOver(e)}),t.cy.on("mouseout",function(e){t.onMouseOut(e)}),t.cy.on("click",function(e){t.onClick(e)}),t.linkSource=null,t}return __extends(i,e),i.prototype.getNodeLabels=function(e){for(var t=[],o=0,n=this.cy.nodes(e);o<n.length;o++){var i=n[o].data("label");-1==t.indexOf(i)&&t.push(i)}return t},i.prototype.getSelectedCyNode=function(){return this.cy.$(":selected")},i.prototype.showPopup=function(e){if(!this.linkSource&&!e.scratch("popup")){var t=Tools.translateViewport($("#cycanvas"),e.renderedBoundingBox()),o=void 0;if(e.isNode()){var n=this.buttonsForType[e.data("type")];if(!n)return;o=new Popup.Popup(n,r.wrap(e)),e.scratch("popup",o),o.show(t.x1+(t.x2-t.x1-o.width())/2,t.y1-o.height())}else o=new Popup.Popup(Popup.Buttons.Delete,r.wrap(e)),e.scratch("popup",o),o.show(t.x1+(t.x2-t.x1-o.width())/2,t.y1+(t.y2-t.y1-o.height())/2);o.pass("add",this),o.pass("link",this),o.pass("edit",this),o.pass("delete",this),o.pass("clone",this)}},i.prototype.clearPopup=function(e){var t=e.scratch("popup");t&&t.destroy(),e.removeScratch("popup")},i.prototype.isLinkable=function(e,t){if(e&&t&&e.isNode()&&t.isNode()){var o=e.data("type"),n=t.data("type");return!e.edgesTo(t).length&&!t.edgesTo(e).length&&((o===n||"stp"===o||"device"===o&&"stp"===n)&&e.id()!==t.id())}return!1},i.prototype.addSTP=function(){this.cy.add({group:"nodes",classes:"stp",position:{x:this.cy.width()/2,y:30},data:{label:"Service Transfer Point",type:"stp"}})},i.prototype.addDevice=function(e){if(e.isBound()){var t=this.cy.getElementById(e.id());t.unselect(),this.clearPopup(t)}var o=this.cy.add({group:"nodes",classes:"device",position:{x:this.cy.width()/2,y:this.cy.height()/2},data:{type:"device"}});try{e.commit(o)}catch(e){throw this.cy.remove(o),e}},i.prototype.addService=function(e,t){if(t.isBound()){var o=this.cy.getElementById(t.id());o.unselect(),this.clearPopup(o)}var n=e.boundingBox(),i=this.cy.add({group:"nodes",classes:"service",position:{x:n.x1+n.w/2,y:n.y1+n.h/2},data:{parent:e.id(),type:"service"}});try{t.commit(i)}catch(e){throw this.cy.remove(i),e}},i.prototype.getNodeById=function(e){return r.wrap(this.cy.getElementById(e))},i.prototype.getNameCompletions=function(e){if(e instanceof c)return this.getNodeLabels("node[type = 'device']");if(e instanceof d)return this.getNodeLabels("node[type = 'service']");throw"Invalid parameter"},i.prototype.deleteNode=function(e){this.getSelectedCyNode().unselect(),this.cy.remove(this.cy.getElementById(e.id()))},i.prototype.getSelected=function(){return this.getSelectedCyNode().map(function(e){return r.wrap(e)})},i.prototype.startLinking=function(e){this.linkSource=this.cy.getElementById(e.id()),$("#cycanvas").css("cursor","no-drop"),this.getSelectedCyNode().unselect()},i.prototype.save=function(){return JSON.stringify(this.cy.json().elements)},i.prototype.load=function(e){this.getSelectedCyNode().unselect(),this.linkSource=void 0,this.clear(),this.cy.json({elements:JSON.parse(e)})},i.prototype.clear=function(){this.getSelectedCyNode().unselect(),this.cy.elements().remove()},i.prototype.resetZoom=function(){this.cy.reset()},i.prototype.getModel=function(){for(var e=new Model.Stp(this.cy.nodes('[type = "stp"]').first().id()),t=new Model.Model(e),o=0,n=this.cy.nodes('node[type = "device"]');o<n.length;o++)!function(e){var o=new Model.Device(e.id(),e.data("ava"),"module"===e.data("flavour"));e.children('node[type = "service"]').map(function(e){o.addService(new Model.Service(e.id(),e.data("label"),e.data("capacity")))});t.addDevice(o)}(n[o]);for(var i=0,r=this.cy.edges();i<r.length;i++){var s=r[i],a=s.data("type"),c=a.charAt(0).toUpperCase()+a.substr(1).toLowerCase(),d=Model.LinkType[c];t.addLink(new Model.Link(d,s.source().id(),s.target().id()))}return t},i.prototype.moveNodeTo=function(e,t,i){var r=e.position(),s=new n;if(i==o.Y?s.y=t.y-r.y:s.x=t.x-r.x,e.isParent())for(var a=0,c=e.children();a<c.length;a++)c[a].shift(s.toPlainObject());else e.shift(s.toPlainObject())},i.prototype.alignSelected=function(e){if(!(this.selectStack.length<2))for(var n=this.selectStack[0].position(),i=e===t.Horizontal?o.Y:o.X,r=0,s=this.cy.$("node:selected");r<s.length;r++){var a=s[r];this.moveNodeTo(a,n,i)}},i.prototype.distributeSelected=function(e){if(!(this.selectStack.length<3)){for(var i=[],r=0,s=this.cy.$("node:selected");r<s.length;r++){h=s[r];i.push(h)}i.sort(function(o,n){var i=e===t.Horizontal?o.position().x:o.position().y,r=e===t.Horizontal?n.position().x:n.position().y,s=e===t.Horizontal?o.position().y:o.position().x,a=e===t.Horizontal?n.position().y:n.position().x,c=i-r;return 0!=c?c:s-a});for(var a=i.length-1,c=e===t.Horizontal?i[0].position().x:i[0].position().y,d=((e===t.Horizontal?i[a].position().x:i[a].position().y)-c)/a,l=e===t.Horizontal?o.X:o.Y,u=0,p=i;u<p.length;u++){var h=p[u];this.moveNodeTo(h,new n(c,c),l),c+=d}}},i.prototype.onSelectNode=function(e){if(null!=this.linkSource){var t=e.target;if(this.isLinkable(this.linkSource,t)){var o=t.data("type");"stp"==o&&(o="device"),this.cy.add({group:"edges",classes:o,data:{type:o,source:this.linkSource.id(),target:t.id()}})}else this.trigger("error","Invalid target selected.");$("#cycanvas").css("cursor",""),this.linkSource=null}else{if(this.selectStack.push(e.target),1!=this.getSelectedCyNode().length)for(var n=0,i=this.getSelectedCyNode();n<i.length;n++){var r=i[n];this.clearPopup(r)}else this.showPopup(e.target);e.target.neighborhood().addClass("selneighborhood")}},i.prototype.onSelectEdge=function(e){this.showPopup(e.target)},i.prototype.onUnSelect=function(e){var t=e.target;this.clearPopup(t),this.selectStack=this.selectStack.filter(function(e){return e.id()!=t.id()}),t.neighborhood().removeClass("selneighborhood")},i.prototype.onDrag=function(e){this.clearPopup(e.target)},i.prototype.onFree=function(e){1==this.getSelectedCyNode().length&&this.showPopup(this.getSelectedCyNode().first())},i.prototype.onPan=function(e){this.getSelectedCyNode().unselect()},i.prototype.onZoom=function(e){this.getSelectedCyNode().unselect()},i.prototype.onMouseOver=function(e){null!=this.linkSource&&e.target&&e.target!==this.cy&&(this.isLinkable(this.linkSource,e.target)?$("#cycanvas").css("cursor","alias"):$("#cycanvas").css("cursor","no-drop"))},i.prototype.onMouseOut=function(e){this.linkSource&&$("#cycanvas").css("cursor","no-drop")},i.prototype.onClick=function(e){null!=this.linkSource&&e.target&&e.target===this.cy&&(this.linkSource=null,$("#cycanvas").css("cursor",""))},i}(Events);e.CytoscapeApi=l}(CytoscapeApi||(CytoscapeApi={}));