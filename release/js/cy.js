"use strict";var __extends=this&&this.__extends||function(){var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])};return function(t,o){function n(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}}(),CytoscapeApi;!function(e){var t=function(){return function(e){void 0===e&&(e=""),this.name=e}}(),o=function(){function e(){}return e.wrap=function(e){switch(e.data("type")){case"device":return new r(e);case"service":return new c(e);case"stp":return new i(e);default:throw"Invalid node type"}},e}(),n=function(){function e(e){this.node=e,this.data=null!=e?new t(e.data("label")):new t}return e.prototype.id=function(){if(null==this.node)throw"Can not get id of unbound node";return this.node.id()},e.prototype.boundingBox=function(){if(null==this.node)throw"Can not get bounding box of unbound node";return this.node.boundingBox()},e.prototype.getName=function(){return this.data.name},e.prototype.getData=function(){return this.data},e.prototype.commit=function(e){if(null!=e&&(this.node=e),null==this.node)throw"Commit can only be called without an argument for already bound nodes.";if(0===this.data.name.length)throw"Please specify a device name.";this.node.data("label",this.data.name)},e.prototype.getPercentage=function(e,t){if(!isFinite(e)||isNaN(e))throw t;var o=parseFloat(e);if(isNaN(o)||o<0||o>100)throw t;return o},e}();e.CyNode=n;var i=function(e){function t(t){return e.call(this,t)||this}return __extends(t,e),t}(n),r=function(e){function t(t){var o=e.call(this,t)||this;return o.data.availability=null!=t?100*o.node.data("ava"):99.5,o}return __extends(t,e),t.prototype.enumServices=function(){return this.node.children("node[type = 'service']").map(function(e){return o.wrap(e)})},t.prototype.commit=function(t){var o=this.getPercentage(this.data.availability,"Availability must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("ava",o/100)},t}(n);e.CyDevice=r;var c=function(e){function t(t){var o=e.call(this,t)||this;return o.data.capacity=null!=t?o.node.data("capacity"):100,o}return __extends(t,e),t.prototype.commit=function(t){var o=this.getPercentage(this.data.capacity,"Capacity must be between 0 and 100%.");e.prototype.commit.call(this,t),this.node.data("capacity",o)},t}(n);e.CyService=c;var s=function(e){function t(){var t=e.call(this)||this;return t.buttonsForType={},t.linkSource=null,t.cy=cytoscape({container:$("#cycanvas"),minZoom:.2,maxZoom:5,style:[{selector:"node",style:{label:"data(label)","text-halign":"center","text-valign":"bottom","text-margin-y":"4px","background-repeat":"no-repeat","background-color":"#f0f0f0","background-fit":"none","background-image-opacity":.4,"border-width":"1px","border-style":"solid","border-color":"#a0a0a0"}},{selector:"edge",style:{}},{selector:"node:selected",style:{"border-width":"4px","border-style":"double","border-color":"#800000"}},{selector:"edge:selected",style:{}},{selector:"node.device",style:{shape:"rectangle","background-image":["images/device.svg"],width:"12em","min-width":"12em",height:"4em","min-height":"4em","background-color":"#a0c0ff","background-width":"80%","background-height":"80%","compound-sizing-wrt-labels":"include"}},{selector:"$node.device > node",style:{"background-image":[]}},{selector:"edge.device",style:{"curve-style":"haystack","line-style":"dashed","line-color":"#a0c0ff"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}},{selector:"node.stp",style:{shape:"roundrectangle","background-color":"#ffa0af","background-width":"2em","background-height":"2em","background-image":["images/stp.svg"],width:"4em",height:"2em"}},{selector:"edge.service",style:{"curve-style":"bezier","line-style":"solid","line-color":"#004000","arrow-scale":2,"target-arrow-shape":"triangle","target-arrow-color":"#004000"}},{selector:"node.service",style:{shape:"roundrectangle","background-color":"#a0ffaf","background-width":"2em","background-height":"2em","background-image":["images/service.svg"],width:"4em",height:"2em"}}]}),t.cy.snapToGrid({gridSpacing:30,lineDash:[2,2],zoomDash:!0}),t.buttonsForType={device:Popup.Buttons.Add|Popup.Buttons.Edit|Popup.Buttons.Link|Popup.Buttons.Delete|Popup.Buttons.Clone,service:Popup.Buttons.Edit|Popup.Buttons.Link|Popup.Buttons.Delete,stp:Popup.Buttons.Link,edge:Popup.Buttons.Delete},t.cy.on("select","node",function(e){t.onSelectNode(e)}),t.cy.on("select","edge",function(e){t.onSelectEdge(e)}),t.cy.on("unselect","*",function(e){t.onUnSelect(e)}),t.cy.on("drag","node",function(e){t.onDrag(e)}),t.cy.on("free","node",function(e){t.onFree(e)}),t.cy.on("pan",function(e){t.onPan(e)}),t.cy.on("zoom",function(e){t.onZoom(e)}),t.cy.on("mouseover",function(e){t.onMouseOver(e)}),t.cy.on("mouseout",function(e){t.onMouseOut(e)}),t.cy.on("click",function(e){t.onClick(e)}),t.linkSource=null,t}return __extends(t,e),t.prototype.getNodeLabels=function(e){for(var t=[],o=0,n=this.cy.nodes(e);o<n.length;o++){var i=n[o].data("label");-1==t.indexOf(i)&&t.push(i)}return t},t.prototype.getSelectedCyNode=function(){return this.cy.$(":selected")},t.prototype.showPopup=function(e){if(!this.linkSource&&!e.scratch("popup")){var t=Tools.translateViewport($("#cycanvas"),e.renderedBoundingBox()),n=void 0;if(e.isNode()){var i=this.buttonsForType[e.data("type")];if(!i)return;n=new Popup.Popup(i,o.wrap(e)),e.scratch("popup",n),n.show(t.x1+(t.x2-t.x1-n.width())/2,t.y1-n.height())}else n=new Popup.Popup(Popup.Buttons.Delete,o.wrap(e)),e.scratch("popup",n),n.show(t.x1+(t.x2-t.x1-n.width())/2,t.y1+(t.y2-t.y1-n.height())/2);n.pass("add",this),n.pass("link",this),n.pass("edit",this),n.pass("delete",this),n.pass("clone",this)}},t.prototype.clearPopup=function(e){var t=e.scratch("popup");t&&t.destroy(),e.removeScratch("popup")},t.prototype.isLinkable=function(e,t){if(e&&t&&e.isNode()&&t.isNode()){var o=e.data("type"),n=t.data("type");return!e.edgesTo(t).length&&!t.edgesTo(e).length&&((o===n||"stp"===o||"device"===o&&"stp"===n)&&e.id()!==t.id())}return!1},t.prototype.addSTP=function(){this.cy.add({group:"nodes",classes:"stp",position:{x:this.cy.width()/2,y:30},data:{label:"Service Transfer Point",type:"stp"}})},t.prototype.addDevice=function(e){var t=this.cy.add({group:"nodes",classes:"device",position:{x:this.cy.width()/2,y:this.cy.height()/2},data:{type:"device"}});e.commit(t)},t.prototype.addService=function(e,t){var o=e.boundingBox(),n=this.cy.add({group:"nodes",classes:"service",position:{x:o.x1+o.w/2,y:o.y1+o.h/2},data:{parent:e.id(),type:"service"}});t.commit(n)},t.prototype.getNodeById=function(e){return o.wrap(this.cy.getElementById(e))},t.prototype.getNameCompletions=function(e){if(e instanceof r)return this.getNodeLabels("node[type = 'device']");if(e instanceof c)return this.getNodeLabels("node[type = 'service']");throw"Invalid parameter"},t.prototype.deleteNode=function(e){this.getSelectedCyNode().unselect(),this.cy.remove(this.cy.getElementById(e.id()))},t.prototype.getSelected=function(){return this.getSelectedCyNode().map(function(e){return o.wrap(e)})},t.prototype.startLinking=function(e){this.linkSource=this.cy.getElementById(e.id()),$("#cycanvas").css("cursor","no-drop"),this.getSelectedCyNode().unselect()},t.prototype.save=function(){return JSON.stringify(this.cy.json().elements)},t.prototype.load=function(e){this.getSelectedCyNode().unselect(),this.linkSource=void 0,this.clear(),this.cy.json({elements:JSON.parse(e)})},t.prototype.clear=function(){this.getSelectedCyNode().unselect(),this.cy.elements().remove()},t.prototype.resetZoom=function(){this.cy.reset()},t.prototype.getModel=function(){for(var e=new Model.Stp(this.cy.nodes('[type = "stp"]').first().id()),t=new Model.Model(e),o=0,n=this.cy.nodes('node[type = "device"]');o<n.length;o++)!function(e){var o=new Model.Device(e.id(),e.data("ava"));e.children('node[type = "service"]').map(function(e){o.addService(new Model.Service(e.id(),e.data("label"),e.data("capacity")))});t.addDevice(o)}(n[o]);for(var i=0,r=this.cy.edges();i<r.length;i++){var c=r[i],s=c.data("type"),a=s.charAt(0).toUpperCase()+s.substr(1).toLowerCase(),d=Model.LinkType[a];t.addLink(new Model.Link(d,c.source().id(),c.target().id()))}return t},t.prototype.onSelectNode=function(e){if(null!=this.linkSource){var t=e.target;if(this.isLinkable(this.linkSource,t)){var o=t.data("type");"stp"==o&&(o="device"),this.cy.add({group:"edges",classes:o,data:{type:o,source:this.linkSource.id(),target:t.id()}})}else this.trigger("error","Invalid target selected.");$("#cycanvas").css("cursor",""),this.linkSource=null}else if(1!=this.getSelectedCyNode().length)for(var n=0,i=this.getSelectedCyNode();n<i.length;n++){var r=i[n];this.clearPopup(r)}else this.showPopup(e.target)},t.prototype.onSelectEdge=function(e){this.showPopup(e.target)},t.prototype.onUnSelect=function(e){this.clearPopup(e.target)},t.prototype.onDrag=function(e){this.clearPopup(e.target)},t.prototype.onFree=function(e){1==this.getSelectedCyNode().length&&this.showPopup(this.getSelectedCyNode().first())},t.prototype.onPan=function(e){this.getSelectedCyNode().unselect()},t.prototype.onZoom=function(e){this.getSelectedCyNode().unselect()},t.prototype.onMouseOver=function(e){null!=this.linkSource&&e.target&&e.target!==this.cy&&(this.isLinkable(this.linkSource,e.target)?$("#cycanvas").css("cursor","alias"):$("#cycanvas").css("cursor","no-drop"))},t.prototype.onMouseOut=function(e){this.linkSource&&$("#cycanvas").css("cursor","no-drop")},t.prototype.onClick=function(e){null!=this.linkSource&&e.target&&e.target===this.cy&&(this.linkSource=null,$("#cycanvas").css("cursor",""))},t}(Events);e.CytoscapeApi=s}(CytoscapeApi||(CytoscapeApi={}));