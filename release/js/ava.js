"use strict";var Ava;!function(e){var i=function(){return function(e,i,t){this.error=t,this.availability=e,this.singlePointsOfFailure=i}}();e.Result=i;var t=function(){function e(e,i){this.deviceMask=new Array(e),this.deviceAva=new Array(e),this.visitedDevices=new Array(e),this.requiredSvcCount=new Array(i),this.activeSvcCount=new Array(i),this.activeSvcMap=new Array(i),this.availability=new Fraction(0),this.singlePointsOfFailure=[],this.deviceMask.fill(!0),this.requiredSvcCount.fill(0)}return e.prototype.reset=function(){this.visitedDevices.fill(!1),this.activeSvcCount.fill(0);for(var e=0;e<this.activeSvcMap.length;e++)this.activeSvcMap[e]={}},e}(),s=function(){function e(e,i,t){this.parents=[],this.childrenOfType={},this.serviceName=i,this.serviceId=e.getNextServiceId(),this.contributionPct=t}return e.prototype.addChild=function(e){e.addParent(this)},e.prototype.addParent=function(e){this.parents.push(e)},e.prototype.getName=function(){return this.serviceName},e.prototype.id=function(){return this.serviceId},e.prototype.getContributionPct=function(){return this.contributionPct},e.prototype.isActive=function(e){return e.activeSvcCount[this.serviceId]>e.requiredSvcCount[this.serviceId]},e.prototype.initCtx=function(e){for(var i=0,t=this.parents;i<t.length;i++){var s=t[i];this.serviceName in e.activeSvcMap[s.id()]||(e.requiredSvcCount[s.id()]++,e.activeSvcMap[s.id()][this.serviceName]=0)}},e.prototype.propagateActivation=function(e){if(this.isActive(e))for(var i=0,t=this.parents;i<t.length;i++)t[i].simulateContribute(e,this)},e.prototype.simulateDeviceActivate=function(e){e.activeSvcCount[this.serviceId]++,this.propagateActivation(e)},e.prototype.simulateContribute=function(e,i){var t=i.getName();t in e.activeSvcMap[this.serviceId]||(e.activeSvcMap[this.serviceId][t]=0),e.activeSvcMap[this.serviceId][t]<100&&(e.activeSvcMap[this.serviceId][t]+=i.getContributionPct(),e.activeSvcMap[this.serviceId][t]>=100&&(e.activeSvcCount[this.serviceId]++,this.propagateActivation(e)))},e}();e.Service=s;var r=function(){function e(e,i){this.children=[],this.services=[],this.stpInstance=e,this.ava=new Fraction(i),this.deviceId=this.stpInstance.getNextDeviceId()}return e.prototype.newDevice=function(e){var i=this.stpInstance.newDevice(e);return this.link(i),i},e.prototype.newService=function(e,i){if(this.services.some(function(i){return i.getName()===e}))throw"Duplicate service name";var t=new s(this.stpInstance,e,i);return this.services.push(t),t},e.prototype.link=function(e,i){void 0===i&&(i=!1),this.children.push(e),i||e.link(this,!0)},e.prototype.id=function(){return this.deviceId},e.prototype.initCtx=function(e){if(!e.visitedDevices[this.deviceId]){e.visitedDevices[this.deviceId]=!0,e.deviceAva[this.deviceId]=this.ava;for(var i=0,t=this.services;i<t.length;i++)t[i].initCtx(e);for(var s=0,r=this.children;s<r.length;s++)r[s].initCtx(e)}},e.prototype.simulate=function(e){if(!e.visitedDevices[this.deviceId]&&(e.visitedDevices[this.deviceId]=!0,e.deviceMask[this.deviceId])){for(var i=0,t=this.services;i<t.length;i++)t[i].simulateDeviceActivate(e);for(var s=0,r=this.children;s<r.length;s++)r[s].simulate(e)}},e}();e.Device=r;var n=function(){function e(){this.numDevices=0,this.numServices=0,this.rootDevice=new r(this,1),this.rootService=new s(this,".",100)}return e.prototype.getNextDeviceId=function(){var e=this.numDevices;return this.numDevices++,e},e.prototype.getNextServiceId=function(){var e=this.numServices;return this.numServices++,e},e.prototype.getRootDevice=function(){return this.rootDevice},e.prototype.getRootService=function(){return this.rootService},e.prototype.newDevice=function(e){if(isNaN(e)||!isFinite(e)||e<0||e>1)throw"Invalid argument";return new r(this,e)},e.prototype.recurseMask=function(e,i,t,s,r){var n,c;if(r[s]){if(e.reset(),this.getRootDevice().simulate(e),this.getRootService().simulateDeviceActivate(e),c=this.getRootService().isActive(e),0===t){for(var v=0,o=0,a=e.visitedDevices;o<a.length;o++)a[o]&&v++;if(v!==e.visitedDevices.length)throw"Not all devices are reachable from the STP. Please check the connections between the devices and the STP.";if(!1===c)throw"Your design does not work with all devices available. Please check the capacity of the services."}if(!c&&1===t)for(u=1;u<this.numDevices;u++)if(!e.deviceMask[u]){e.singlePointsOfFailure.push(u);break}n=e.visitedDevices.slice()}else c=!0,n=r;if(c){for(var h=new Fraction(1),u=0;u<this.numDevices;u++)h=e.deviceMask[u]?h.mul(e.deviceAva[u]):h.mul(new Fraction(1).sub(e.deviceAva[u]));e.availability=e.availability.add(h);for(u=s;u<this.numDevices;u++)i&&i(u,this.numDevices),e.deviceMask[u]&&(e.deviceMask[u]=!1,this.recurseMask(e,void 0,t+1,u,n),e.deviceMask[u]=!0)}},e.prototype.calculate=function(e){var s=new t(this.numDevices,this.numServices);s.reset(),this.rootDevice.initCtx(s);try{return this.recurseMask(s,e,0,1,new Array(this.numDevices).fill(!0)),new i(s.availability.valueOf(),s.singlePointsOfFailure)}catch(e){return new i(0,[],e)}},e}();e.Stp=n}(Ava||(Ava={}));